Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force -Confirm
Set-Location $PSScriptRoot

$datetime = (Get-Date -f yyyy-MM-dd_HH-mm)
$logfile = "IACS_malware_Scan_Report_" + $datetime + ".log"

Start-Transcript -Append $logfile -IncludeInvocationHeader

Write-Host ("--- Kill previous MSERT processes and remove old logs") -ForegroundColor Cyan
#Kill any MSERT
Get-Process | Where-Object { $_.Name -eq "MSERT"} | Select-Object -First 5
Get-Process | Where-Object { $_.Name -eq "MSERT"} | Select-Object -First 1 | Stop-Process
Sleep 5
#Remove logs
Remove-Item C:\Windows\Debug\msert.log

Write-Host ("--- Implenting malware signature (eicar signature)")  -ForegroundColor Cyan
#https://www.eicar.org/download-anti-malware-testfile/
cd C:\draeger\ssm\
Set-content "X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*" -path "eicar.com"
Get-FileHash eicar.com -a SHA256

Set-Location $PSScriptRoot
Write-Host ("--- Version of MSERT.exe:")  -ForegroundColor Cyan
(Get-Item MSERT.exe).VersionInfo.FileVersionRaw | Format-Table
Write-Host ("--- Starting MSERT.exe:")  -ForegroundColor Cyan
$Argument = "/Q /F:Y"
Start-Process MSERT.exe $Argument -PassThru
$Starttime = (Get-Date)
Sleep 7

do{

    Get-Process | Where-Object { $_.Name -eq "MSERT"} | Select-Object -First 1
    Sleep 60
    $span = New-TimeSpan -Start $Starttime -End $(Get-Date)
    Write-Host ("- Time: $(Get-Date) Duration: $span") -ForegroundColor Cyan

} while ((Get-Process -name MSERT -ErrorAction SilentlyContinue) -ne $null)

Get-Content C:\Windows\Debug\msert.log

Stop-Transcript